# Deregister plugin from firmware
REGISTER="/usr/local/opnsense/scripts/firmware/register.php"
VERSION_INFO="/usr/local/opnsense/version/kea-ddns"
if [ -f "$REGISTER" ] && [ -f "$VERSION_INFO" ]; then
    PLUGIN_ID=$(sed -n 's/.*"product_id"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' "$VERSION_INFO")
    if [ -n "$PLUGIN_ID" ]; then
        $REGISTER remove "$PLUGIN_ID"
    fi
fi

VERSION_FILE="/usr/local/opnsense/version/core"
PATCH_DIR="/usr/local/opnsense/data/kea-ddns/patches"

# detect OPNsense series
SERIES=""
if [ -f "$VERSION_FILE" ]; then
    SERIES=$(sed -n 's/.*"product_series"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' "$VERSION_FILE")
fi

if [ -z "$SERIES" ]; then
    echo "WARNING: Could not detect OPNsense series from $VERSION_FILE"
    exit 0
fi

PATCH="$PATCH_DIR/$SERIES.patch"

if [ ! -f "$PATCH" ]; then
    echo "WARNING: No patch file for OPNsense series $SERIES ($PATCH not found)"
    exit 0
fi

echo "Reversing kea-ddns core hooks patch for OPNsense $SERIES..."
if cd /usr/local && patch --dry-run --reverse --strip=1 < "$PATCH" >/dev/null 2>&1; then
    patch --reverse --strip=1 < "$PATCH" || \
        echo "NOTE: Core patch reversal failed unexpectedly."
else
    echo "NOTE: Core patch could not be reversed cleanly (OPNsense may have been updated)."
fi
